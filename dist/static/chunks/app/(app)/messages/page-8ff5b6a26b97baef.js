(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2164],{3119:(e,t,s)=>{"use strict";s.d(t,{_K:()=>d,gM:()=>c});var a,r,l,n=s(5704);let i=void 0!==n?n.env:{},d={NODE_ENV:null!=(a=i.NODE_ENV)?a:"development",NEXT_PUBLIC_SUPABASE_URL:null!=(r=i.NEXT_PUBLIC_SUPABASE_URL)?r:"",NEXT_PUBLIC_SUPABASE_ANON_KEY:null!=(l=i.NEXT_PUBLIC_SUPABASE_ANON_KEY)?l:""};function c(){var e;let t=null==(e=i.NEXT_PUBLIC_APP_HOST)?void 0:e.trim();if(t)return t.replace(/\/+$/,"")}i.NEXT_PUBLIC_APP_ORIGIN,d.NEXT_PUBLIC_SUPABASE_URL,d.NEXT_PUBLIC_SUPABASE_ANON_KEY},4148:(e,t,s)=>{Promise.resolve().then(s.bind(s,7721))},7721:(e,t,s)=>{"use strict";s.d(t,{default:()=>o});var a=s(5155),r=s(2115),l=s(2659),n=s(3119);let i=(0,l.UU)(n._K.NEXT_PUBLIC_SUPABASE_URL,n._K.NEXT_PUBLIC_SUPABASE_ANON_KEY);function d(e){let{threadId:t,userId:s,onSent:l}=e,[n,d]=(0,r.useState)(""),[c,o]=(0,r.useState)(!1),m=c||0===n.trim().length||n.length>4e3;async function h(){if(!n.trim())return;o(!0);let e={id:crypto.randomUUID(),thread_id:t,sender_id:s,body:n,created_at:new Date().toISOString()};null==l||l(e),d("");let{data:a,error:r}=await i.from("messages").insert([{thread_id:t,sender_id:s,body:e.body}]).select("*").single();o(!1),r?console.error(r):null==l||l(a)}return(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{"data-testid":"chat-input",value:n,onChange:e=>d(e.target.value),className:"flex-1 border rounded px-3 py-2",placeholder:"Type a message…"}),(0,a.jsx)("button",{"data-testid":"chat-send",onClick:h,disabled:m,className:"btn-primary px-4 py-2 rounded",children:"Send"})]})}function c(e){var t,s;let{msg:r,self:l}=e;async function n(){let e=prompt("Why are you reporting this message?")||"";try{await fetch("/api/reports/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"message",target_id:r.id,reason:e})}),alert("Reported")}catch(e){}}return(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsxs)("div",{className:"text-xs opacity-70",children:[null!=(s=null==(t=r.profiles)?void 0:t.full_name)?s:r.sender," •"," ",new Date(r.created_at).toLocaleString()]}),(0,a.jsx)("div",{className:"whitespace-pre-wrap",children:r.body}),(0,a.jsx)("button",{onClick:n,className:"text-xs underline",children:"Report"})]})}function o(e){let{userId:t}=e,[s,l]=(0,r.useState)([]),[n,o]=(0,r.useState)(null),[m,h]=(0,r.useState)(!0),{items:u,setItems:x,loading:_}=function(e,t){let[s,a]=(0,r.useState)([]),[l,n]=(0,r.useState)(!!e);(0,r.useEffect)(()=>{if(!e)return;let t=!1;(async()=>{n(!0);let{data:s,error:r}=await i.from("messages").select("*").eq("thread_id",e).order("created_at",{ascending:!0});t||(!r&&s&&a(s),n(!1))})();let s=function(e,t){let s=i.channel("messages:thread:".concat(e)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"thread_id=eq.".concat(e)},e=>t(e.new)).subscribe();return()=>{i.removeChannel(s)}}(e,e=>a(t=>t.some(t=>t.id===e.id)?t:[...t,e]));return()=>{t=!0,null==s||s()}},[e]);let d=(0,r.useMemo)(()=>(t&&s.filter(e=>e.sender_id!==t).length,0),[s,t]);return{items:s,setItems:a,loading:l,unreadCount:d}}(n||void 0,t);(0,r.useEffect)(()=>{g()},[]);let g=async()=>{try{let e=await fetch("/api/applications/with-messages");if(e.ok){let t=await e.json();l(t),t.length>0&&!n&&o(t[0].id)}}catch(e){console.error("Failed to fetch applications:",e)}finally{h(!1)}};if(m)return(0,a.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,a.jsx)("div",{className:"text-gray-500",children:"Loading conversations..."})});if(0===s.length)return(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-600 mb-2",children:"No conversations yet"}),(0,a.jsx)("p",{className:"text-gray-500",children:"Messages will appear here when you apply for jobs or receive applications."})]});let p=s.find(e=>e.id===n);return(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]",children:[(0,a.jsxs)("div",{className:"lg:col-span-1 border rounded-lg overflow-hidden",children:[(0,a.jsx)("div",{className:"bg-gray-50 px-4 py-3 border-b",children:(0,a.jsx)("h2",{className:"font-semibold",children:"Conversations"})}),(0,a.jsx)("div",{className:"overflow-y-auto h-full",children:s.map(e=>(0,a.jsxs)("div",{onClick:()=>o(e.id),className:"p-4 border-b cursor-pointer hover:bg-gray-50 ".concat(n===e.id?"bg-blue-50 border-blue-200":""),children:[(0,a.jsx)("div",{className:"font-medium text-sm truncate",children:e.gig_title}),(0,a.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:[e.employer_name," • ",e.worker_name]}),(0,a.jsx)("div",{className:"text-xs text-gray-400 mt-1",children:new Date(e.created_at).toLocaleDateString()})]},e.id))})]}),(0,a.jsx)("div",{className:"lg:col-span-2 border rounded-lg flex flex-col",children:p?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"bg-gray-50 px-4 py-3 border-b",children:[(0,a.jsx)("h3",{className:"font-semibold",children:p.gig_title}),(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:[p.employer_name," • ",p.worker_name]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:_?(0,a.jsx)("div",{className:"text-center text-gray-500",children:"Loading messages..."}):0===u.length?(0,a.jsx)("div",{className:"text-center text-gray-500",children:"No messages yet. Start the conversation!"}):u.map(e=>(0,a.jsx)(c,{msg:{id:parseInt(e.id),body:e.body,sender:e.sender_id,created_at:e.created_at,profiles:null},self:t},e.id))}),(0,a.jsx)("div",{className:"border-t p-4",children:(0,a.jsx)(d,{threadId:n,userId:t,onSent:e=>{x(t=>[...t,e])}})})]}):(0,a.jsx)("div",{className:"flex items-center justify-center h-full text-gray-500",children:"Select a conversation to start messaging"})})]})}}},e=>{e.O(0,[2659,8441,1255,7358],()=>e(e.s=4148)),_N_E=e.O()}]);