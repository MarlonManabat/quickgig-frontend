name: Bootstrap backend (deploy + install + seed)

on:
  workflow_dispatch:

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    env:
      BASE: https://api.quickgig.ph
      HOST: ${{ secrets.HOSTINGER_HOST }}
      PORT: ${{ secrets.HOSTINGER_PORT }}
      USER: ${{ secrets.HOSTINGER_USER }}
      REMOTE: ${{ secrets.HOSTINGER_REMOTE_DIR }}
      ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync lftp

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOSTINGER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "$PORT" "$HOST" >> ~/.ssh/known_hosts

      - name: Test SSH and prepare remote dir
        run: |
          set -euxo pipefail
          ssh -p "$PORT" "$USER@$HOST" "echo connected && mkdir -p '$REMOTE'"

      - name: Deploy API via rsync
        run: |
          set -euxo pipefail
          rsync -e "ssh -p $PORT" -av --delete api.quickgig.ph/ "$USER@$HOST:$REMOTE/"

      - name: Health check (with fallback)
        run: |
          set -euxo pipefail
          curl -fsS "$BASE/status" || curl -fsS "$BASE/health.php"

      - name: Run installer (idempotent)
        run: |
          set -euxo pipefail
          curl -fsS "$BASE/tools/install.php?token=RUN_ONCE" | head -c 200 || true

      - name: Seed sample event
        run: |
          set -euxo pipefail
          curl -fsS -X POST "$BASE/admin/events/create.php" \
            -H "Content-Type: application/json" \
            -H "X-Admin-Token: $ADMIN_TOKEN" \
            --data-raw '{
              "slug":"launch-party",
              "title":"Launch Party",
              "venue":"Makati",
              "start_time":"2025-09-10 19:00:00",
              "status":"published",
              "ticket_types":[
                {"name":"General","price_cents":50000,"quantity_total":100},
                {"name":"VIP","price_cents":112000,"quantity_total":20}
              ]
            }' || true

      - name: Verify events JSON
        run: |
          curl -fsS "$BASE/events/index.php" | jq '.[0] | {id,slug,title}'

