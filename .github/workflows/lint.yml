name: Lint

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

permissions:
  contents: write

jobs:
  lock_guard:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.heal.outputs.updated || 'false' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - id: ci
        run: npm ci --ignore-scripts --no-audit --fund=false --loglevel=error
        continue-on-error: true
      - id: heal
        if: steps.ci.outcome == 'failure'
        run: |
          set -e
          npm install --package-lock-only --ignore-scripts --no-audit --fund=false --loglevel=error
          if git diff --quiet package-lock.json; then
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 1
          else
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add package-lock.json
            git commit -m "chore(lockfile): sync lockfile (CI self-heal)"
            git push
            echo "updated=true" >> $GITHUB_OUTPUT
            exit 78
          fi
  eslint:
    needs: lock_guard
    if: needs.lock_guard.outputs.updated != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm run ci:lock
      - run: npm run ci:install
      - run: npm run lint
